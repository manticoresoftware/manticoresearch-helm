name: k3s Testing
on:
  pull_request:
    branches: [ master ]

jobs:
  build-balancer-amd64:
    concurrency:
      group: "build-balancer-amd64-${{ github.event.number }}"
      cancel-in-progress: true
    runs-on: [ubuntu-latest]
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Get changed files
        id: changed-files
        uses: actions/github-script@v6
        with:
          script: |
            const response = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });
            const files = response.data.map(file => file.filename);
            const testOnly = files.length > 0 && files.every(file => file.startsWith('clt_tests/'));
            core.setOutput('test-only', testOnly);

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push balancer (amd64)
        uses: docker/build-push-action@v4
        if: steps.changed-files.outputs.test-only != 'true'
        with:
          context: ./sources/manticore-balancer
          platforms: linux/amd64
          push: true
          tags: manticoresearch/helm-balancer:0.0.0-unstable-amd64
          cache-from: type=registry,ref=manticoresearch/helm-balancer:cache-amd64
          cache-to: type=inline

  build-balancer-arm64:
    concurrency:
      group: "build-balancer-arm64-${{ github.event.number }}"
      cancel-in-progress: true
    runs-on: [ubuntu-24.04-arm]
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Get changed files
        id: changed-files
        uses: actions/github-script@v6
        with:
          script: |
            const response = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });
            const files = response.data.map(file => file.filename);
            const testOnly = files.length > 0 && files.every(file => file.startsWith('clt_tests/'));
            core.setOutput('test-only', testOnly);

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push balancer (arm64)
        uses: docker/build-push-action@v4
        if: steps.changed-files.outputs.test-only != 'true'
        with:
          context: ./sources/manticore-balancer
          platforms: linux/arm64
          push: true
          tags: manticoresearch/helm-balancer:0.0.0-unstable-arm64
          cache-from: type=registry,ref=manticoresearch/helm-balancer:cache-arm64
          cache-to: type=inline

  build-worker-amd64:
    concurrency:
      group: "build-worker-amd64-${{ github.event.number }}"
      cancel-in-progress: true
    runs-on: [ubuntu-latest]
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Get changed files
        id: changed-files
        uses: actions/github-script@v6
        with:
          script: |
            const response = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });
            const files = response.data.map(file => file.filename);
            const testOnly = files.length > 0 && files.every(file => file.startsWith('clt_tests/'));
            core.setOutput('test-only', testOnly);

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push worker (amd64)
        uses: docker/build-push-action@v4
        if: steps.changed-files.outputs.test-only != 'true'
        with:
          context: ./sources/manticore-worker
          platforms: linux/amd64
          push: true
          tags: manticoresearch/helm-worker:0.0.0-unstable-amd64
          cache-from: type=registry,ref=manticoresearch/helm-worker:cache-amd64
          cache-to: type=inline

  build-worker-arm64:
    concurrency:
      group: "build-worker-arm64-${{ github.event.number }}"
      cancel-in-progress: true
    runs-on: [ubuntu-24.04-arm]
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Get changed files
        id: changed-files
        uses: actions/github-script@v6
        with:
          script: |
            const response = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });
            const files = response.data.map(file => file.filename);
            const testOnly = files.length > 0 && files.every(file => file.startsWith('clt_tests/'));
            core.setOutput('test-only', testOnly);

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push worker (arm64)
        uses: docker/build-push-action@v4
        if: steps.changed-files.outputs.test-only != 'true'
        with:
          context: ./sources/manticore-worker
          platforms: linux/arm64
          push: true
          tags: manticoresearch/helm-worker:0.0.0-unstable-arm64
          cache-from: type=registry,ref=manticoresearch/helm-worker:cache-arm64
          cache-to: type=inline

  create-manifests:
    needs: [build-balancer-amd64, build-balancer-arm64, build-worker-amd64, build-worker-arm64]
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Create and push balancer manifest
        run: |
          docker manifest create manticoresearch/helm-balancer:0.0.0-unstable \
            --amend manticoresearch/helm-balancer:0.0.0-unstable-amd64 \
            --amend manticoresearch/helm-balancer:0.0.0-unstable-arm64
          docker manifest push --purge manticoresearch/helm-balancer:0.0.0-unstable

      - name: Create and push worker manifest
        run: |
          docker manifest create manticoresearch/helm-worker:0.0.0-unstable \
            --amend manticoresearch/helm-worker:0.0.0-unstable-amd64 \
            --amend manticoresearch/helm-worker:0.0.0-unstable-arm64
          docker manifest push --purge manticoresearch/helm-worker:0.0.0-unstable

  tests:
    needs: [create-manifests]
    concurrency:
      group: "tests-${{ github.event.number }}"
      cancel-in-progress: true
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: debianmaster/actions-k3s@v1.0.5
        id: k3s
        with:
          version: 'latest'

      - name: Wait for k3s to be ready
        run: |
          echo "Waiting for k3s to be ready"
          until kubectl get nodes --kubeconfig ${{ steps.k3s.outputs.kubeconfig }} | grep -q " Ready "; do
            echo "Waiting..."
            sleep 2
          done
          echo "k3s is ready"

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - uses: manticoresoftware/clt@0.6.3
        with:
          image: manticoresearch/helm-test-kit:0.0.1
          test_prefix: clt_tests/tests/
          run_args: -e TELEMETRY=0 --net=host -v ${{ steps.k3s.outputs.kubeconfig }}:${{ steps.k3s.outputs.kubeconfig }} -v $(pwd)/charts/:/.clt/charts/